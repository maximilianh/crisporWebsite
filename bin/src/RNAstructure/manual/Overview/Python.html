<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
	<head>
		<title>RNAstructure Installation and Overview: Building the Repository</title>
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
		<link href="Stylesheet.css" rel="stylesheet" type="text/css">
        <style type="text/css">
			.componentName { 
				font-weight: bold; 
				font-family: Consolas, "Courier New", Courier, monofont;
			}
		</style>
	</head>
	<body>
		<div class="bodydiv">
			<table cellpadding="0" cellspacing="0" border="0" class="mainTable">
				<tr class="headerRow">
					<td class="headerBox"><img src="icon.jpg" alt="RNAstructure logo"></td>
					<td class="headerLabel"><h2>RNAstructure Python Interfaces</h2></td>
					<td class="headerBox2">
						<ul id="navigator">
							<li><h3 class="noMarginOrPad"><a href="index.html">Contents</a></h3></li>
							<li><h3 class="noMarginOrPad"><a href="AlphabeticalIndex.html">Index</a></h3></li>
						</ul>
					</td>
				</tr>
				<tr>
					<td class="mainContent" colspan="3">
					  <div>
					    <p>RNAstructure tools can be accessed from the Python scripting language by accessing the RNAstructure Python Interface, which is a Python extension module. 
					    <p>Most <a href="../RNA_class/html/annotated.html">RNAstructure classes</a> have Python bindings, including:                         
                        <ul>
                           <li> RNA</li>
                           <li> ProbScan</li>
                           <li> Dynalign_object</li>
                           <li>HybridRNA</li>
                           <li> Multilign_object</li>
                           <li> Oligowalk_object</li>
                        </ul>
						 <p>
					     The file components of the extension are listed below:                                                                                   
				        <table border="0" cellspacing="0" cellpadding="3" style="width:95%;">
						   <tr>
						     <td valign="top" class="componentName">&bull;&nbsp;RNAstructure.py</td>
						     <td valign="top">The main RNAstructure Python class.</td>
				          </tr>
						   <tr>
						     <td valign="top" class="componentName">&bull;&nbsp;Error_handling.py</td>
						     <td valign="top">An internal utility that turns RNAstructure numeric error codes into Python exceptions.</td>
					       </tr>
						   <tr>
						     <td valign="top" class="componentName">&bull;&nbsp;RNAstructure_wrap.py</td>
						     <td valign="top"> The Python-code interface between RNAstructure.py and the native (C++) binary library.<br>
					         (This is generated by SWIG.)</td>
					       </tr>
						   <tr>
						     <td valign="top"><span class="componentName">&bull;&nbsp;_RNAstructure_wrap.so</span><br>
			                   <em>or</em>&nbsp;<span class="componentName">_RNAstructure_wrap.dll</span></td>
						     <td valign="top">Native (C++) binary library that adds Python bindings to the RNAstructure class library.<br>

<em>The name of this file depends on the operating-system and the version of python.
		<br>In <strong>python 3</strong>, C++ extensions have long platform-specific suffixes, like <strong>_RNAstructure_wrap.cpython-36m-x86_64-linux-gnu.so</strong>
		<br>For simplicity it is always called <strong>_RNAstructure_wrap.so</strong> in the documentation below.
</em>
</td>
					       </tr>
					    </table>
						 <p>In source-only releases of RNAstructure, the Python scripts  (*.py) can be found in the <strong class="pathName">python_interface</strong> directory. They are copied into the <span class="pathName">RNAstructure/exe</span> directory when the binary library (<strong>_RNAstructure_wrap.so</strong>) is compiled as described below.
						 <p>In binary releases of RNAstructure, all components can be found in the <strong class="pathName">RNAstructure/exe</strong> directory. However, due to many system-dependant factors (i.e. Python version and flavor, processor architecture etc) the pre-compiled binary library (<strong>_RNAstructure_wrap.so</strong>) may not be compatible with your specifc Python environment, in which case it must be compiled as described below.
				        <h2>Compiling the RNAstructure Python Interface</h2>
					    To compile the RNAstructure Python Interface binary library (<strong>_RNAstructure_wrap.so</strong>), both Python and the necessary Python development tools (header files, etc) must be installed on your system. (See the <a href="#Troubleshooting">Troubleshooting</a> section for details.)<br><br>                         
Open a terminal an run the following command from with the root RNAstructure directory:<br>
<pre class="codeBlock codeThemeShell"><span class="codeComment"># Enter this shell command from the RNAstructure directory</span><br>make python</pre>
<br>
<br>
Compiled Python native (C++) extensions are, in general, only compatible with a single version of Python. Because of this, the default behavior of the `make python` command is to build 
two libraries -- one for Python 2.x and another for Python 3.x.<br>
If you only want to build one of these libraries, or if you wish to target an alternative version of Python, you can do so by specifying the <span class="codeText">PYTHON</span> environment variable, as shown below.<br>
This is also a useful strategy if python is not available in your PATH.  For example:<br>
<pre class="codeBlock codeThemeShell"><span class="codeComment"># Examples for using a different version of Python or specifying a path</span>
make python <span class="codeKeyword">PYTHON=python3</span>              <span class="codeComment"># Use Python 3.x</span><br>make python <span class="codeKeyword">PYTHON=/usr/bin/python2.7</span>   <span class="codeComment"># Specify full path</span></pre>
<br>
<br>

The library and all python files required by the extension will be copied to the <span class="pathName">RNAstructure/exe</span> directory.<br>
	                    If errors are encountered when building the interface, please see the <a href="#Troubleshooting">Troubleshooting</a> section below. 
		                <h2>Rebuilding the SWIG Wrappers</h2>
SWIG is used to make the connection between the C++ backend and the Python interface.  The SWIG wrappers are provided prebuilt in <span class="pathName">RNAstructure/python_interface</span>, so that installation and use of SWIG is not required.  Changes to the wrapped RNAstructure classes, however, will require rebuilding the wrappers with SWIG.  To update the wrappers, in the <span class="pathName">RNAstructure/python_interface</span> directory, use the command `make swig`.  This will update the files <strong>RNAstructure_wrap.cxx</strong> and <strong>RNAstructure_wrap.py</strong>.
<h2>Using the RNAstructure Python Interface</h2>
		                In order to use the RNAstructure Python Interface from a Python script or the Python interpreter, all components listed above must be located in a directory where Python will look for modules/extensions. This can be done by either (A) Setting the <strong class="codeText">PYTHONPATH</strong> environment variable to include the directory where the extension files are located or (B) Moving the required files into a directory listed in Python's <span class="codeText"><strong>sys.path</strong></span>. The extension files are typically located in <span class="pathName">RNAstructure/exe</span>, so the following should work in most cases:
		                <pre class="codeBlock codeThemeShell"><span class="codeComment">
# Set PYTHONPATH to include the location of the RNAstructure module
# </span><span class="codeKeyword"><em>path/to/RNAstructure</em>/exe</span><span class="codeComment"> can be a relative or absolute path.
# If running python from within the RNAstructure root directory, just use &quot;</span><span class="codeKeyword">exe</span><span class="codeComment">&quot;</span>
export PYTHONPATH=<span class="codeKeyword"><em>path/to/RNAstructure</em>/exe</span><br><span class="codeComment"># or</span>
export PYTHONPATH<span class="codeSymbol">+=:</span><span class="codeKeyword"><em>path/to/RNAstructure</em>/exe</span> <span class="codeComment"># preserves existing PYTHONPATH</span></pre>
		                <br>
		                <br>
		                The following commands can be entered into a <strong>Python interpreter </strong>or written to a python script file to demonstrate the RNAstructure module:<br>
		                <pre class="codeBlock">
<span class="codeComment">#### Python Code ####

# First import the RNAstructure module</span>
<span class="codeKeyword">import</span> RNAstructure

<span class="codeComment"># Access the in-line documentation</span>
help(RNAstructure)

<span class="codeComment"># Each class and method has in-line documentation.</span>
help(RNAstructure.RNA)<br>help(RNAstructure.RNA.FoldSingleStrand())<br>help(RNAstructure.ProbScan.probability_of_multibranch_loop)

<span class="codeComment"># Each class can be instantiated with its fromString and fromFile methods </span>
p = RNAstructure.RNA.fromString(<span class="codeString">&quot;GGGGAAACCCC&quot;</span>)
q = RNAstructure.RNA.fromFile(<span class="codeString">&quot;../tests/time/ivslsu.seq&quot;</span>)
m = RNAstructure.Dynalign_object.fromString(<span class="codeString">&quot;CGCGCGUUCGGCGCGC&quot;</span>,<span class="codeString">&quot;GCGCGCUUCAGCGCGC&quot;</span>)

<span class="codeComment"># The classes have structure calculation methods identical to those in the C++ classes</span>
p.FoldSingleStrand()<br>p.PartitionFunction()<br>m.Dynalign()

<span class="codeComment"># The multiple-sequence classes such as dynalign have multiple RNA 
# objects that can be accessed.</span><br>rna2 = m.GetRNA2() <span class="codeComment"># returns an RNA</span>

<span class="codeComment"># They have IO methods to write structures to disc</span><br>p.WriteCt(<span class="codeString">&quot;foo.ct&quot;</span>)<br>m.GetRNA2.WriteCt(<span class="codeString">&quot;bar.ct&quot;</span>)

<span class="codeComment"># RNA and ProbScan objects are iterable. To iterate over the sequence:</span><br><span class="codeKeyword2">for</span> nuc <span class="codeKeyword2">in</span> p: <span class="codeKeyword">print</span> nuc
<span class="codeComment"># Or over the nucleotide indices:</span>
<span class="codeKeyword2">for</span> i <span class="codeKeyword2">in</span> p.iterIndices(): <span class="codeKeyword">print</span> GetNucleotide(i)<span class="codeComment"> #identical behavior to previous line.</span>

<span class="codeComment"># It's also possible to get the pairing information and to manipulate it within python</span>
pairs = <span class="codeSymbol">[</span>(i,p.GetPair(i)) <span class="codeKeyword2">for</span> i <span class="codeKeyword2">in</span> p.iterIndices()<span class="codeSymbol">]</span>
<span class="codeComment"># Or pair probabilities</span>
p.GetPairProbability(1,10)<span class="codeComment">  # returns 0.437</span></pre >
						  <a name="Troubleshooting"></a>
						  <h2>Troubleshooting</h2>
                        <div style="font-family: Arial, Helvetica, sans-serif">
					    <h3>Notes for  Compiling the Interface</h3>
						  <ol>
						    <li>Your system should be configured to allow python to be invoked directly as `<span class="codeText">python</span>`.<br>
						      If that is not the case, please do <strong>ONE</strong> of the following:
					        </li>
						    <ol type="A">
						      <li>						      Set your <strong class="codeText">PATH</strong> to include the location of the python executable.</li>
						      <li>						      Create a symlink (in <span class="pathName">~/bin</span> or <span class="pathName">/usr/bin</span> etc) so `<span class="codeText">python</span>` points to the desired executable.</li>
						      <li>						      Define the <strong class="codeText">PYTHON</strong> environment variable to point to the desired executable. <br>
						        <pre class="codeBlock smBlock codeThemeShell">export PYTHON=python3          <span class="codeComment"># Example using Python 3.x</span>
export PYTHON=/usr/bin/python  <span class="codeComment"># Example using full path</span></pre></li>
<li>
						        Specify PYTHON directly on the Make command-line:<br>
						        <pre class="codeBlock smBlock codeThemeShell">make python  <span class="codeKeyword">PYTHON=/usr/bin/python3</span></pre>
						      </li>
					        </ol>
						    <li>To build the native python extension, you must also have the python development <br>
					        headers and libraries installed. If you get an error about a <span class="specialName">missing Python.h</span>
                            file, it is likely you'll have to install the development tools using the appropriate command below:
                            <ul>
	              <li>
					              For apt (Ubuntu, Debian...):<br>
					              <pre class="codeBlock smBlock codeThemeShell">sudo apt-get install <span class="codeKeyword">python-dev</span>   <span class="codeComment"># for python2.x installs</span>
sudo apt-get install <span class="codeKeyword">python3-dev</span>  <span class="codeComment"># for python3.x installs</span></pre>
                  </li>
					            <li>					              For yum (CentOS, RHEL...):<br>
					              <pre class="codeBlock smBlock codeThemeShell">sudo yum install python-devel</pre></li>
					            <li>					              For dnf (Fedora...):<br>
					              <pre class="codeBlock smBlock codeThemeShell">sudo dnf install python2-devel  <span class="codeComment"># for python2.x installs</span><br>sudo dnf install python3-devel  <span class="codeComment"># for python3.x installs</span></pre>
					            </li>
					            <li>					              For zypper (openSUSE...):<br>
					              <pre class="codeBlock smBlock codeThemeShell">sudo zypper in python-devel   <span class="codeComment"># for python2.x installs</span><br>sudo zypper in python3-devel<span class="codeComment">  # for python3.x installs</span></pre>
					            </li>
					            <li>					              For Cygwin: <br>
					              <pre class="codeBlock codeThemeShell">
<span class="codeComment"># If apt-cyg is installed</span>
apt-cyg install python2-devel   <span class="codeComment"># for python2.x installs</span>
apt-cyg install python3-devel   <span class="codeComment"># for python3.x installs</span>
<span class="codeComment"># Or use the Cygwin installer to select and install the python2-devel 
# or python3-devel package.</span><br></pre>
					            </li>
				              </ul>
						    </li>
						    <li> There are two distinct ways to compile the RNAstructure Python Interface. The first is recommended, but if it fails on your system, try the second method.
						      <ol type="A">
						        <li>						       RNAstructure Build (<em>Recommended</em>): This uses the normal RNAstructure Makefile build system to <br>
						          compile the object files and final shared extension library. It should work well in most cases.<br>

						          <pre class="codeBlock smBlock codeThemeShell">make python <span class="codeComment"># compile using RNAstructure build system</span>
<span class="codeComment"># or </span>
make python PYTHON=python3<span class="codeComment"> # to specify name or path of python</span></pre></li>
<li>Python <strong>distutils</strong> Build: This uses Python's distutils package to automatically configure and build <br>
						          the the object files and final shared extension library. It uses Python's common extension <br>
						          paradigm (<em>setup.py</em>).<br>
						          <pre class="codeBlock  codeThemeShell">make python_dist  <span class="codeComment"># compile using <em>distutils</em> build system (setup.py)</span>
<span class="codeComment"># or </span>
make python_dist PYTHON=python3<span class="codeComment"> # to specify name or path of python</span></pre>
						        </li>
					          </ol>
					        </li>
					      </ol>
						  <h3>Notes for  Compiling the Interface on Windows</h3>
						  <ol start="4">
						    <li>If you choose to use the <strong>distutils</strong> method (see #3 above), python might use the wrong compiler name. This results in an error: <span class="shellError">/bin/bash: gcc: command not found</span><br>
						      <strong>Workaround</strong>: <br>
						      Create a symlink named &quot;gcc&quot; in <span class="pathName">~/bin</span> or <span class="pathName">/usr/bin</span> etc that points to <span class="pathName">/usr/bin/x86_64-w64-mingw32-g++</span>						      (or whatever your compiler is named -- this is for MinGW-w64). <br>
					        You may also need to do this for &quot;g++&quot;.</li>
						    <li>					          If compiling from the native Windows python executable (as opposed to cygwin's python), <br>
						      you may need to choose which compiler to use.<br>
						      Add the following lines to <span class="pathName">RNAstructure/setup.cfg</span> or <span class="pathName">/usr/lib/pythonXX/distutils/distutils.cfg</span> (neither of which may exist prior to you creating them).<br>
						      <pre class="codeBlock smBlock">
<span class="codeComment"># Python config settings (add to setup.cfg or distutils.cfg)</span>
[build_ext]
compiler=mingw32

[build]
compiler=mingw32</pre>
					          <br>
				            (Also see <a href="https://wiki.python.org/moin/WindowsCompilers">WindowsCompilers</a> on <a href="http://wiki.python.org">wiki.python.org</a>)</li>
						    <li>						      Compiler error:<br>
						      <span class="shellError">pyport.h:351:24: fatal error: sys/select.h: No such file or directory</span><br>
						      On Windows, you may need to edit <span class="pathName">pyconfig.h</span> in the python <em>include</em> directory (for example  <span class="pathName">/usr/include/python2.7/pyconfig.h</span>) You can find this directory by running<br>
<pre class="codeBlock smBlock codeThemeShell">make python-debug</pre><br>
from the root RNAstructure  directory. Look for the <strong>PY_INCLUDE_DIR</strong> definition in the output.<br>
Once you have located <span class="pathName">pyconfig.h</span>, open it in a text editor  and search for the following variables and undefine them:  <strong>HAVE_SYS_SELECT_H</strong> and&nbsp;&nbsp;<strong>HAVE_SYS_TERMIO_H</strong><br>
						      i.e.: put these statements <strong>below</strong> the corresponding #define's<br>
						      <pre class="codeBlock smBlock">
<span class="codeComment">#define HAVE_SYS_SELECT_H 1  // already in the file</span>
<strong>#undef HAVE_SYS_SELECT_H</strong>     <span class="codeComment">// <strong>Add this line.</strong></span>
<span class="codeComment">
// ... a few lines later ...</span>

<span class="codeComment">#define HAVE_SYS_TERMIO_H    // already in the file</span>
<strong>#undef HAVE_SYS_TERMIO_H</strong>     <span class="codeComment">// <strong>Add this line.</strong></span></pre>
						      <br>
					        </li>
						    <li>There is a bug in <span class="pathName">cygwinccompiler.py</span> (in python's <strong>distutils</strong> directory).<br>
It gives the following error:<br>
<pre class="shellError autosize">  File "/usr/lib/python2.7/distutils/<span class="codeSymbol">cygwinccompiler.py</span>", line 189, in link
	libraries.extend(self.dll_libraries)
  TypeError: <span class="codeSymbol">'NoneType' object is not iterable</span></pre><br>
						      <strong>Workaround</strong>: find and edit <span class="pathName">cygwinccompiler.py</span> (use the path as shown in the error message)<br>
						      Go to the line number mentioned in the error. The code should be similar to <br>
						      <pre class="codeBlock smBlock"><span class="codeComment"># Additional libraries</span><br>libraries.extend(self.dll_libraries)</pre><br>
						      Change it to this:<br>
                              <pre class="codeBlock smBlock"><span class="codeComment"># Additional libraries</span><br><span class="codeKeyword">if self.dll_libraries:</span> libraries.extend(self.dll_libraries)</pre><br>
</li>
						    <li>Import fails at runtime: <span class="shellError">&quot;ImportError: No such file or directory&quot;</span><br>
					        See #3 in the next section.</li>
					      </ol>
						  <h3>						      Notes on Running the Python Interface</h3>
						  <ol>
						    <li>Python scripts that which to use the RNAstructure extension should have the following import statement:<br>
					        <pre class="codeBlock smBlock">import RNAstructure</pre></li>
						    <li>The environment variable <strong>PYTHONPATH</strong> must include the directory that contains all of the following files.<br>
						      These files are normally placed in the RNAstructure/exe directory, so PYTHONPATH should point there, unless<br>
you have installed the files in another location.<br>
<ul>
  <li>						      RNAstructure.py</li>
  <li>						      Error_handling.py</li>
  <li>						      RNAstructure_wrap.py</li>
  <li>						      _RNAstructure_wrap.so (aka _RNAstructure_wrap.dll on Windows)</li>
</ul>
						    </li>
						    <li> <strong>On Windows</strong>: the python <strong>distutils</strong> build system creates an interface binary that is dynamically linked with system libraries.<br>
						      If the system libraries are not available on the PATH, you will get an import error, similar to this:<br>
						      <pre class="shellError autosize">  _RNAstructure_wrap = swig_import_helper()
  File "/home/rna/rna/RNAstructure/exe/RNAstructure_wrap.py", line 16, in swig_import_helper
	return <span class="codeSymbol">importlib.import_module('_RNAstructure_wrap')</span>
  File "/usr/lib/python2.7/importlib/__init__.py", line 37, in import_module
	__import__(name)
  <span class="codeSymbol">ImportError: No such file or directory</span></pre><br>
    <strong>Workaround</strong>: Add system libraries to your path.<br>
						      <pre class="codeBlock smBlock codeThemeShell">PATH+=:'/usr/x86_64-w64-mingw32/sys-root/mingw/bin' </pre><br>
						      The above path pay not be appropriate for your system. You can list the <br>
					        required dynamically linked files with the following shell command:<br>
					        <pre class="codeBlock smBlock codeThemeShell">ldd exe/_RNAstructure_wrap.dll</pre>
					        <br>
					        In the output, look for these files (if present) and make sure their parent directory is in your PATH: 
					        <ul>
					          <li class="codeText"><strong>libgcc_s_seh-1.dll</strong></li>
					          <li class="codeText"><strong>libwinpthread-1.dll</strong></li>
					          <li class="codeText"><strong>libstdc++-6.dll</strong></li>
					          </ul>
                              The following files may also be present, but can be ignored:<br>
                            <span class="codeText">&nbsp;&nbsp;ntdll.dll &nbsp;kernel32.dll&nbsp; KERNELBASE.dll&nbsp; msvcrt.dll <br>
&nbsp;                            USER32.dll &nbsp;GDI32.dll &nbsp;LPK.dll &nbsp;USP10.dll &nbsp;libpython2.7.dll</span></li>
					      </ol>
                        </div>
					  </div>
<div></div>
					</td>
				</tr>
				<tr>
					<td class="footer" colspan="3">
						<p>Visit <a href="http://rna.urmc.rochester.edu/RNAstructure.html">The Mathews Lab RNAstructure Page</a> for updates and latest information.</p>
					</td>
				</tr>
			</table>
		</div>
	</body>
</html>
